generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Post {
  id          Int      @id @default(autoincrement())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])

  @@index([name])
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  providerEmail            String?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                          String                     @id @default(cuid())
  name                        String?
  email                       String?                    @unique
  emailVerified               DateTime?
  image                       String?
  onboardingCompletedAt       DateTime?
  onboardingStep              Int                        @default(1)
  projectSetupCompletedAt     DateTime?
  selectedTools               String[]
  usageType                   String?
  userRole                    String?
  isAdmin                     Boolean                    @default(false)
  emailMarketingOptIn         Boolean                    @default(true)
  workRole                    String?
  workFunction                String[]
  usagePurposes               String[]
  lastLogin                   DateTime?
  defaultWorkspaceId          String?
  accounts                    Account[]
  actions                     Action[]
  actionAssignees             ActionAssignee[]           @relation("ActionAssignees")
  aiInteractionHistory        AiInteractionHistory[]
  feedback                    Feedback[]
  goals                       Goal[]
  integrations                Integration[]
  permissionsGrantedBy        IntegrationPermission[]    @relation("PermissionGrantedBy")
  permissionsGrantedTo        IntegrationPermission[]    @relation("PermissionGrantedTo")
  permissionsRevokedBy        IntegrationPermission[]    @relation("PermissionRevokedBy")
  integrationMappings         IntegrationUserMapping[]
  notes                       Note[]
  notificationPreferences     NotificationPreference?
  navigationPreference        NavigationPreference?
  calendarPreferences         CalendarPreference[]
  outcomes                    Outcome[]
  posts                       Post[]
  projects                    Project[]
  projectMemberships          ProjectMember[]
  scheduledNotifications      ScheduledNotification[]
  sessions                    Session[]
  slackChannelsConfigured     SlackChannelConfig[]
  slackMessageHistory         SlackMessageHistory[]
  slackRegistrations          SlackRegistrationToken[]
  teams                       TeamUser[]
  transcriptionSessions       TranscriptionSession[]
  exercises                   UserExercise[]
  verificationTokens          VerificationToken[]
  whatsappConversations       WhatsAppConversation[]
  whatsappGatewaySessions     WhatsAppGatewaySession[]
  workflows                   Workflow[]
  weeklyOutcomesCreated       WeeklyOutcome[]            @relation("WeeklyOutcomeCreated")
  weeklyOutcomeAssignees      WeeklyOutcomeAssignee[]    @relation("WeeklyOutcomeAssignee")
  teamCapacities              TeamMemberWeeklyCapacity[] @relation("TeamMemberCapacity")
  weeklyReviewSharing         WeeklyReviewSharing[]
  weeklyReviewCompletions     WeeklyReviewCompletion[]
  wheelOfLifeAssessments      WheelOfLifeAssessment[]
  habits                      Habit[]
  ownedWorkspaces             Workspace[]                @relation("WorkspaceOwner")
  workspaceMemberships        WorkspaceUser[]
  resources                   Resource[]
  workspaceInvitationsCreated WorkspaceInvitation[]      @relation("InvitationCreator")
  // CRM relations
  crmContactsCreated          CrmContact[]               @relation("CrmContactCreatedBy")
  crmOrganizationsCreated     CrmOrganization[]          @relation("CrmOrganizationCreatedBy")
  crmInteractions             CrmContactInteraction[]    @relation("CrmInteractionUser")
  crmCommunicationsCreated    CrmCommunication[]         @relation("CrmCommunicationCreatedBy")
  crmTemplatesCreated         CrmCommunicationTemplate[] @relation("CrmTemplateCreatedBy")
  crmImportBatchesCreated     ContactImportBatch[]       @relation("CrmImportBatchCreatedBy")
  // Plugin and OKR relations
  pluginConfigs               PluginConfig[]
  keyResults                  KeyResult[]
  keyResultCheckIns           KeyResultCheckIn[]         @relation("KeyResultCheckInCreator")
  driGoals                    Goal[]                     @relation("GoalDRI")
  driKeyResults               KeyResult[]                @relation("KeyResultDRI")
  // Tag relations
  tagsCreated                 Tag[]                      @relation("TagCreator")
  // View relations
  viewsCreated                View[]                     @relation("ViewsCreated")
  // OKR Check-in relations
  facilitatedOkrCheckins      OkrCheckin[]               @relation("OkrCheckinFacilitator")
  okrCheckinUpdates           OkrCheckinUpdate[]         @relation("OkrCheckinUpdateUser")
  okrCheckinComments          OkrCheckinComment[]        @relation("OkrCheckinCommentAuthor")
  // OKR Discussion relations
  goalComments                GoalComment[]              @relation("GoalCommentAuthor")
  keyResultComments           KeyResultComment[]         @relation("KeyResultCommentAuthor")
  // Daily Planning relations
  dailyPlans                  DailyPlan[]
  // Webhook activity logs
  webhookLogs                 WebhookLog[]
  // Auto-scheduling relations
  taskSchedulesCreated        TaskSchedule[]             @relation("TaskScheduleCreator")
  recurringTasksCreated       RecurringTask[]            @relation("RecurringTaskCreator")

  // Onboarding: Attribution
  attributionSource           String?                    // "google", "twitter", "linkedin", "friend", "youtube", "podcast", "other"

  // Onboarding: Work Hours
  workHoursEnabled            Boolean                    @default(true)
  workDaysJson                String?                    // JSON array: ["monday","tuesday","wednesday","thursday","friday"]
  workHoursStart              String?                    @default("09:00")
  workHoursEnd                String?                    @default("17:00")
  // DRI (Directly Responsible Individual) relation
  driProjects                 Project[]                  @relation("ProjectDRI")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([identifier, token])
  @@index([userId])
}

// ============================================
// Workspace Models
// ============================================

model Workspace {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  type        String   @default("personal") // "personal" | "team" | "organization"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  ownerId     String

  owner             User                       @relation("WorkspaceOwner", fields: [ownerId], references: [id])
  members           WorkspaceUser[]
  projects          Project[]
  goals             Goal[]
  outcomes          Outcome[]
  actions           Action[]
  teams             Team[]
  resources         Resource[]
  invitations       WorkspaceInvitation[]
  views             View[]
  // CRM relations
  crmContacts       CrmContact[]
  crmOrganizations  CrmOrganization[]
  crmInteractions   CrmContactInteraction[]
  crmCommunications CrmCommunication[]
  crmTemplates      CrmCommunicationTemplate[]
  crmImportBatches  ContactImportBatch[]
  // Plugin and OKR relations
  pluginConfigs            PluginConfig[]
  keyResults               KeyResult[]
  // Tag relations
  tags                     Tag[]
  weeklyReviewCompletions  WeeklyReviewCompletion[]
  okrCheckins              OkrCheckin[]
  // Daily Planning relations
  dailyPlans               DailyPlan[]
  // Meetings/Transcription relations
  transcriptionSessions    TranscriptionSession[]
  // Auto-scheduling relations
  taskSchedules            TaskSchedule[]
  recurringTasks           RecurringTask[]

  @@index([slug])
  @@index([ownerId])
  @@index([type])
}

model WorkspaceUser {
  id          String   @id @default(cuid())
  userId      String
  workspaceId String
  role        String   @default("member") // "owner" | "admin" | "member" | "viewer"
  joinedAt    DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
}

model WorkspaceInvitation {
  id          String    @id @default(cuid())
  workspaceId String
  email       String
  role        String    @default("member") // "admin" | "member" | "viewer"
  token       String    @unique
  status      String    @default("pending") // "pending" | "accepted" | "expired" | "cancelled"
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  acceptedAt  DateTime?
  createdById String

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy User      @relation("InvitationCreator", fields: [createdById], references: [id])

  @@unique([workspaceId, email])
  @@index([token])
  @@index([email])
  @@index([workspaceId])
  @@index([status])
}

model View {
  id           String      @id @default(cuid())
  name         String
  slug         String
  description  String?

  viewType     ViewType    @default(KANBAN)
  groupBy      ViewGroupBy @default(STATUS)
  filters      Json        @default("{}")   // { projectIds?, statuses?, priorities?, assigneeIds?, tagIds?, includeCompleted? }
  sortConfig   Json        @default("{}")   // { field: string, direction: 'asc' | 'desc' }

  isSystem     Boolean     @default(false)  // System views cannot be deleted
  isDefault    Boolean     @default(false)  // Default view for workspace
  displayOrder Int         @default(0)

  workspaceId  String
  createdById  String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  workspace    Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy    User        @relation("ViewsCreated", fields: [createdById], references: [id])

  @@unique([workspaceId, slug])
  @@index([workspaceId])
  @@index([createdById])
  @@index([isSystem])
}

model Action {
  id                     String                @id @default(cuid())
  name                   String
  description            String?
  dueDate                DateTime?
  scheduledStart         DateTime?             // When to start this action (time-blocking)
  scheduledEnd           DateTime?             // When to end this action (optional)
  duration               Int?                  // Duration in minutes (alternative to scheduledEnd)
  status                 String                @default("ACTIVE")
  priority               String                @default("Quick")
  projectId              String?
  createdById            String
  teamId                 String?
  workspaceId            String?
  transcriptionSessionId String?
  kanbanStatus           ActionStatus?
  kanbanOrder            Int?
  completedAt            DateTime?
  source                 String?               @default("app") // "app", "ios-shortcut", "notion", "api", "transcription"

  // Auto-scheduling fields (Motion-like features)
  isAutoScheduled        Boolean               @default(true)
  isHardDeadline         Boolean               @default(false)
  scheduleId             String?
  idealStartTime         String?

  // ETA & Progress tracking
  etaDaysOffset          Int?
  etaStatus              String?               // "on_track" | "at_risk" | "overdue"
  timeSpentMins          Int                   @default(0)

  // Task chunking
  chunkDurationMins      Int?
  parentChunkId          String?
  chunkNumber            Int?
  totalChunks            Int?

  // Recurring task support
  isRecurring            Boolean               @default(false)
  recurringParentId      String?
  instanceDate           DateTime?

  // Task dependencies (blocking relationships)
  blockedByIds           String[]
  blockingIds            String[]

  // Reminder task (not scheduled on calendar)
  isReminderOnly         Boolean               @default(false)

  createdBy              User                  @relation(fields: [createdById], references: [id])
  project                Project?              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team                   Team?                 @relation(fields: [teamId], references: [id])
  workspace              Workspace?            @relation(fields: [workspaceId], references: [id])
  transcriptionSession   TranscriptionSession? @relation(fields: [transcriptionSessionId], references: [id])
  schedule               TaskSchedule?         @relation(fields: [scheduleId], references: [id])
  recurringParent        RecurringTask?        @relation("RecurringInstances", fields: [recurringParentId], references: [id])
  parentChunk            Action?               @relation("ActionChunks", fields: [parentChunkId], references: [id], onDelete: SetNull)
  childChunks            Action[]              @relation("ActionChunks")
  syncs                  ActionSync[]
  assignees              ActionAssignee[]
  weeklyOutcomes         WeeklyOutcome[]       @relation("WeeklyOutcomeActions")
  tags                   ActionTag[]
  dailyPlanActions       DailyPlanAction[]

  @@index([projectId])
  @@index([createdById])
  @@index([teamId])
  @@index([workspaceId])
  @@index([transcriptionSessionId])
  @@index([kanbanStatus])
  @@index([scheduleId])
  @@index([recurringParentId])
  @@index([parentChunkId])
  @@index([isAutoScheduled])
  @@index([etaStatus])
}

model ActionAssignee {
  id       String @id @default(cuid())
  actionId String
  userId   String
  action   Action @relation(fields: [actionId], references: [id], onDelete: Cascade)
  user     User   @relation("ActionAssignees", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([actionId, userId])
  @@index([actionId])
  @@index([userId])
}

model Outcome {
  id             String     @id @default(cuid())
  description    String
  dueDate        DateTime?
  userId         String?
  type           String?    @default("daily")
  whyThisOutcome String?
  projectId      String?
  workspaceId    String?
  user           User?      @relation(fields: [userId], references: [id], onDelete: Restrict)
  workspace      Workspace? @relation(fields: [workspaceId], references: [id])
  goals          Goal[]     @relation("GoalOutcomes")
  projects       Project[]  @relation("ProjectOutcomes")

  @@index([userId])
  @@index([projectId])
  @@index([workspaceId])
}

model Project {
  id                    String                     @id @default(cuid())
  name                  String
  status                String                     @default("ACTIVE")
  priority              String                     @default("NONE")
  progress              Float                      @default(0)
  createdAt             DateTime                   @default(now())
  reviewDate            DateTime?
  nextActionDate        DateTime?
  createdById           String
  slug                  String                     @unique
  description           String?
  teamId                String?
  workspaceId           String?
  taskManagementConfig  Json?
  taskManagementTool    String?                    @default("internal")
  notionProjectId       String?
  driId                 String?
  actions               Action[]
  aiInteractionHistory  AiInteractionHistory[]
  createdBy             User                       @relation(fields: [createdById], references: [id])
  dri                   User?                      @relation("ProjectDRI", fields: [driId], references: [id])
  team                  Team?                      @relation(fields: [teamId], references: [id])
  workspace             Workspace?                 @relation(fields: [workspaceId], references: [id])
  projectMembers        ProjectMember[]
  slackConfig           SlackChannelConfig?
  transcriptionSessions TranscriptionSession[]
  workflows             Workflow[]
  goals                 Goal[]                     @relation("GoalProjects")
  outcomes              Outcome[]                  @relation("ProjectOutcomes")
  weeklyOutcomes        WeeklyOutcome[]
  memberCapacities      TeamMemberWeeklyCapacity[] @relation("ProjectCapacities")
  lifeDomains           LifeDomain[]               @relation("ProjectLifeDomains")
  resources             Resource[]
  recurringTasks        RecurringTask[]
  keyResults            KeyResultProject[]         // Key results this project contributes to

  @@index([name])
  @@index([status])
  @@index([priority])
  @@index([teamId])
  @@index([workspaceId])
  @@index([taskManagementTool])
  @@index([driId])
}

model Video {
  id            String    @id @default(uuid())
  slug          String?   @unique
  title         String?
  videoUrl      String    @unique
  transcription String?
  status        String
  createdAt     DateTime? @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime? @default(now()) @updatedAt @db.Timestamptz(6)
  isSearchable  Boolean?  @default(false)
  description   String?
  summary       String?
}

model Week {
  id        Int      @id @default(autoincrement())
  startDate DateTime
  endDate   DateTime
  days      Day[]
}

model Day {
  id        Int            @id @default(autoincrement())
  date      DateTime
  weekId    Int
  week      Week           @relation(fields: [weekId], references: [id])
  notes     Note[]
  exercises UserExercise[]

  @@index([weekId])
}

model Exercise {
  id            Int            @id @default(autoincrement())
  title         String
  description   String?
  userExercises UserExercise[]
}

model UserExercise {
  id         Int      @id @default(autoincrement())
  userId     String
  exerciseId Int
  dayId      Int
  day        Day      @relation(fields: [dayId], references: [id])
  exercise   Exercise @relation(fields: [exerciseId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([exerciseId])
  @@index([dayId])
}

model Goal {
  id           Int        @id @default(autoincrement())
  title        String
  description  String?
  whyThisGoal  String? // "Why this value goal?" motivation text
  notes        String? // Notes field for each goal
  dueDate      DateTime?
  period       String?    // OKR period e.g., "Q1-2026", "Annual-2026"
  lifeDomainId Int?
  userId       String
  driUserId    String?
  workspaceId  String?
  lifeDomain   LifeDomain? @relation(fields: [lifeDomainId], references: [id])
  user         User       @relation(fields: [userId], references: [id])
  driUser      User?      @relation("GoalDRI", fields: [driUserId], references: [id])
  workspace    Workspace? @relation(fields: [workspaceId], references: [id])
  outcomes     Outcome[]  @relation("GoalOutcomes")
  projects     Project[]  @relation("GoalProjects")
  habits       Habit[] // Habits linked to this goal
  keyResults   KeyResult[] // OKR key results for this goal (objective)
  comments     GoalComment[] // Discussion comments on this objective

  @@index([lifeDomainId])
  @@index([userId])
  @@index([driUserId])
  @@index([workspaceId])
}

model Habit {
  id          String    @id @default(cuid())
  title       String
  description String?
  frequency   String    @default("daily") // daily, 3x_week, weekly, bi_weekly, monthly, custom
  daysOfWeek  Int[] // Array of day numbers (0=Sunday, 1=Monday, etc.) for custom scheduling
  timeOfDay   String? // Optional reminder time (e.g., "08:00")
  startDate   DateTime  @default(now())
  endDate     DateTime?
  isActive    Boolean   @default(true)
  goalId      Int? // Optional link to a Goal
  userId      String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  goal        Goal?             @relation(fields: [goalId], references: [id], onDelete: SetNull)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  completions HabitCompletion[]

  @@index([userId])
  @@index([goalId])
  @@index([isActive])
}

model HabitCompletion {
  id            String   @id @default(cuid())
  habitId       String
  completedDate DateTime @db.Date // The date the habit was completed (no time component)
  completedAt   DateTime @default(now()) // Timestamp when marked complete
  notes         String? // Optional notes for this completion
  duration      Int? // Optional duration in minutes
  rating        Int? // Optional quality/rating 1-5

  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([habitId, completedDate]) // One completion per habit per day
  @@index([habitId])
  @@index([completedDate])
}

model LifeDomain {
  id               Int                @id @default(autoincrement())
  title            String
  description      String?
  icon             String? // Tabler icon name (e.g., "IconBriefcase")
  color            String? // Semantic color key (e.g., "brand-primary")
  displayOrder     Int                @default(0)
  isActive         Boolean            @default(true)
  goals            Goal[]
  assessmentScores WheelOfLifeScore[]
  projects         Project[]          @relation("ProjectLifeDomains")
}

model Note {
  id        Int      @id @default(autoincrement())
  content   String
  type      String
  title     String?
  dayId     Int
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  day       Day      @relation(fields: [dayId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@index([dayId])
  @@index([userId])
  @@index([type])
}

model ProjectMember {
  id               String   @id @default(cuid())
  name             String
  role             String
  responsibilities String[]
  avatarUrl        String?
  projectId        String
  userId           String
  project          Project  @relation(fields: [projectId], references: [id])
  user             User     @relation(fields: [userId], references: [id])

  @@index([projectId])
  @@index([userId])
}

model Team {
  id                      String                     @id @default(cuid())
  name                    String
  slug                    String                     @unique
  description             String?
  isOrganization          Boolean                    @default(false)
  workspaceId             String?
  createdAt               DateTime                   @default(now())
  updatedAt               DateTime                   @updatedAt
  workspace               Workspace?                 @relation(fields: [workspaceId], references: [id])
  actions                 Action[]
  integrations            Integration[]
  integrationPermissions  IntegrationPermission[]
  projects                Project[]
  slackConfig             SlackChannelConfig?
  slackRegistrationTokens SlackRegistrationToken[]
  members                 TeamUser[]
  weeklyOutcomes          WeeklyOutcome[]
  memberCapacities        TeamMemberWeeklyCapacity[] @relation("TeamMemberCapacities")
  weeklyReviewSharing     WeeklyReviewSharing[]
  okrCheckins             OkrCheckin[]

  @@index([slug])
  @@index([isOrganization])
  @@index([workspaceId])
}

model TeamUser {
  id       String   @id @default(cuid())
  userId   String
  teamId   String
  role     String   @default("member")
  joinedAt DateTime @default(now())
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@index([userId])
  @@index([teamId])
}

model Differentiator {
  id          String   @id @default(cuid())
  value       String   @unique
  label       String
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  description String   @default("")
}

model Audience {
  id          String   @id @default(cuid())
  value       String   @unique
  label       String
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  description String   @default("")
}

model TranscriptionSession {
  id                  String       @id @default(cuid())
  sessionId           String       @unique
  transcription       String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  meetingDate         DateTime? // Actual date/time when the meeting occurred
  userId              String?
  setupId             String?
  projectId           String?
  description         String?
  title               String?
  summary             String?
  notes               String?
  processedAt         DateTime?
  actionsSavedAt      DateTime?
  slackNotificationAt DateTime?
  archivedAt          DateTime?
  sourceIntegrationId String?
  workspaceId         String?

  // Embedding status tracking for knowledge base
  embeddingStatus     String?      @default("none") // none|pending|processing|completed|failed
  embeddingError      String?
  embeddedAt          DateTime?
  chunkCount          Int?

  actions             Action[]
  screenshots         Screenshot[]
  project             Project?     @relation(fields: [projectId], references: [id])
  sourceIntegration   Integration? @relation(fields: [sourceIntegrationId], references: [id])
  user                User?        @relation(fields: [userId], references: [id])
  workspace           Workspace?   @relation(fields: [workspaceId], references: [id])

  @@index([sessionId])
  @@index([workspaceId])
  @@index([userId])
  @@index([projectId])
  @@index([sourceIntegrationId])
  @@index([embeddingStatus])
}

model Screenshot {
  id                     String               @id @default(cuid())
  url                    String
  timestamp              String
  transcriptionSessionId String
  createdAt              DateTime             @default(now())
  transcriptionSession   TranscriptionSession @relation(fields: [transcriptionSessionId], references: [id])
}

model Integration {
  id                      String                   @id @default(cuid())
  name                    String
  type                    String
  provider                String
  status                  String                   @default("ACTIVE")
  description             String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  userId                  String?
  teamId                  String?
  lastSyncAt              DateTime?
  allowTeamMemberAccess   Boolean                  @default(false)
  team                    Team?                    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user                    User?                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentials             IntegrationCredential[]
  permissions             IntegrationPermission[]
  userMappings            IntegrationUserMapping[]
  notificationPreferences NotificationPreference[]
  scheduledNotifications  ScheduledNotification[]
  slackChannelConfigs     SlackChannelConfig[]
  slackRegistrationTokens SlackRegistrationToken[]
  transcriptionSessions   TranscriptionSession[]
  whatsappConfig          WhatsAppConfig?
  workflows               Workflow[]

  @@index([userId])
  @@index([teamId])
  @@index([provider])
}

model IntegrationCredential {
  id            String      @id @default(cuid())
  key           String
  keyType       String
  expiresAt     DateTime?
  isEncrypted   Boolean     @default(true)
  createdAt     DateTime    @default(now())
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
}

model IntegrationUserMapping {
  id             String      @id @default(cuid())
  integrationId  String
  externalUserId String
  userId         String
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  integration    Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([integrationId, externalUserId])
  @@index([integrationId])
  @@index([userId])
  @@index([externalUserId])
}

model Workflow {
  id            String        @id @default(cuid())
  name          String
  type          String
  provider      String
  status        String        @default("ACTIVE")
  syncDirection String
  syncFrequency String
  config        Json
  integrationId String
  userId        String
  projectId     String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  lastRunAt     DateTime?
  integration   Integration   @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  project       Project?      @relation(fields: [projectId], references: [id])
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  runs          WorkflowRun[]

  @@index([userId])
  @@index([integrationId])
  @@index([status])
  @@index([provider])
}

model WorkflowRun {
  id             String    @id @default(cuid())
  workflowId     String
  status         String
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  itemsProcessed Int       @default(0)
  itemsCreated   Int       @default(0)
  itemsUpdated   Int       @default(0)
  itemsSkipped   Int       @default(0)
  errorMessage   String?
  metadata       Json?
  workflow       Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
}

model SlackChannelConfig {
  id                 String      @id @default(cuid())
  slackChannel       String
  isActive           Boolean     @default(true)
  projectId          String?     @unique
  teamId             String?     @unique
  integrationId      String
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  configuredByUserId String
  configuredBy       User        @relation(fields: [configuredByUserId], references: [id], onDelete: Cascade)
  integration        Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  project            Project?    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team               Team?       @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([teamId])
  @@index([integrationId])
  @@index([configuredByUserId])
}

model IntegrationPermission {
  id              String      @id @default(cuid())
  integrationId   String
  grantedToUserId String?
  grantedToTeamId String?
  grantedByUserId String
  permissions     String[]
  scope           String
  scopeEntityId   String?
  expiresAt       DateTime?
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  revokedAt       DateTime?
  revokedByUserId String?
  grantedBy       User        @relation("PermissionGrantedBy", fields: [grantedByUserId], references: [id], onDelete: Cascade)
  grantedToTeam   Team?       @relation(fields: [grantedToTeamId], references: [id], onDelete: Cascade)
  grantedToUser   User?       @relation("PermissionGrantedTo", fields: [grantedToUserId], references: [id], onDelete: Cascade)
  integration     Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  revokedBy       User?       @relation("PermissionRevokedBy", fields: [revokedByUserId], references: [id])

  @@index([integrationId])
  @@index([grantedToUserId])
  @@index([grantedToTeamId])
  @@index([grantedByUserId])
  @@index([scope, scopeEntityId])
}

model ActionSync {
  id         String   @id @default(cuid())
  actionId   String
  provider   String
  externalId String
  syncedAt   DateTime @default(now())
  updatedAt  DateTime @updatedAt
  status     String   @default("synced")
  action     Action   @relation(fields: [actionId], references: [id], onDelete: Cascade)

  @@unique([actionId, provider])
  @@index([provider, externalId])
  @@index([provider])
  @@index([actionId])
}

model SlackRegistrationToken {
  id            String      @id @default(cuid())
  token         String      @unique
  slackUserId   String
  integrationId String
  teamId        String?
  createdAt     DateTime    @default(now())
  expiresAt     DateTime
  usedAt        DateTime?
  usedByUserId  String?
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  team          Team?       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  usedByUser    User?       @relation(fields: [usedByUserId], references: [id])

  @@index([token])
  @@index([slackUserId])
  @@index([integrationId])
  @@index([expiresAt])
}

model SlackEvent {
  id          String   @id @default(cuid())
  eventKey    String   @unique
  processedAt DateTime @default(now())

  @@index([eventKey])
  @@index([processedAt])
}

model SlackMessageHistory {
  id           String   @id @default(cuid())
  slackEventId String?
  channelId    String
  channelType  String
  timestamp    String
  slackUserId  String
  systemUserId String?
  userName     String?
  rawMessage   String
  cleanMessage String
  messageType  String?
  agentUsed    String?
  responseTime Int?
  hadError     Boolean  @default(false)
  errorMessage String?
  category     String?
  intent       String?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [systemUserId], references: [id])

  @@index([slackUserId])
  @@index([systemUserId])
  @@index([category])
  @@index([intent])
  @@index([createdAt])
  @@index([channelType])
  @@index([messageType])
}

model AiInteractionHistory {
  id              String     @id @default(cuid())
  platform        String
  sourceId        String?
  systemUserId    String?
  externalUserId  String?
  userName        String?
  userMessage     String
  cleanMessage    String?
  aiResponse      String
  agentId         String?
  agentName       String?
  model           String?
  conversationId  String?
  messageType     String?
  intent          String?
  category        String?
  responseTime    Int?
  tokenUsage      Json?
  hadError        Boolean    @default(false)
  errorMessage    String?
  confidenceScore Float?
  projectId       String?
  actionsTaken    Json?
  toolsUsed       String[]
  userAgent       String?
  ipAddress       String?
  createdAt       DateTime   @default(now())
  project         Project?   @relation(fields: [projectId], references: [id])
  user            User?      @relation(fields: [systemUserId], references: [id])
  feedback        Feedback[]

  @@index([systemUserId])
  @@index([platform])
  @@index([agentId])
  @@index([conversationId])
  @@index([category])
  @@index([intent])
  @@index([projectId])
  @@index([createdAt])
  @@index([platform, systemUserId])
  @@index([conversationId, createdAt])
}

model Feedback {
  id              String                @id @default(cuid())
  userId          String
  feature         String
  rating          Int
  content         String
  metadata        Json?
  aiInteractionId String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiInteraction   AiInteractionHistory? @relation(fields: [aiInteractionId], references: [id])

  @@index([userId])
  @@index([feature])
  @@index([createdAt])
  @@index([feature, rating])
  @@index([aiInteractionId])
}

model FeatureRequest {
  id            String    @id @default(cuid())
  title         String
  description   String
  embedding     Float[]
  priority      Int       @default(0)
  status        String    @default("open")
  feedbackCount Int       @default(1)
  avgRating     Float?
  feedbackIds   String[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  resolvedAt    DateTime?

  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

model WhatsAppConfig {
  id                 String                       @id @default(cuid())
  phoneNumberId      String
  businessAccountId  String
  webhookVerifyToken String
  displayPhoneNumber String?
  businessName       String?
  integrationId      String                       @unique
  createdAt          DateTime                     @default(now())
  updatedAt          DateTime                     @updatedAt
  integration        Integration                  @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  conversations      WhatsAppConversation[]
  messageAnalytics   WhatsAppMessageAnalytics[]
  performanceMetrics WhatsAppPerformanceMetrics[]
  rateLimitTracking  WhatsAppRateLimitTracking[]
  templates          WhatsAppTemplate[]
  webhookDeliveries  WhatsAppWebhookDelivery[]

  @@index([integrationId])
}

model WhatsAppTemplate {
  id                 String                  @id @default(cuid())
  name               String
  language           String
  status             String
  category           String
  headerType         String?
  headerText         String?
  bodyText           String
  footerText         String?
  buttons            Json?
  whatsappTemplateId String?
  rejectionReason    String?
  whatsappConfigId   String
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  whatsappConfig     WhatsAppConfig          @relation(fields: [whatsappConfigId], references: [id], onDelete: Cascade)
  usageMetrics       WhatsAppTemplateUsage[]

  @@unique([whatsappConfigId, name])
  @@index([whatsappConfigId])
  @@index([status])
}

model WhatsAppConversation {
  id               String         @id @default(cuid())
  phoneNumber      String
  userId           String?
  messages         Json
  lastMessageAt    DateTime       @default(now())
  messageCount     Int            @default(0)
  whatsappConfigId String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  user             User?          @relation(fields: [userId], references: [id])
  whatsappConfig   WhatsAppConfig @relation(fields: [whatsappConfigId], references: [id], onDelete: Cascade)

  @@unique([phoneNumber, whatsappConfigId])
  @@index([phoneNumber])
  @@index([userId])
  @@index([lastMessageAt])
}

model NotificationPreference {
  id                    String       @id @default(cuid())
  userId                String       @unique
  integrationId         String?
  taskReminders         Boolean      @default(true)
  projectUpdates        Boolean      @default(true)
  dailySummary          Boolean      @default(true)
  weeklySummary         Boolean      @default(false)
  timezone              String       @default("UTC")
  dailySummaryTime      String?      @default("09:00")
  weeklyDayOfWeek       Int?         @default(1)
  reminderMinutesBefore Int[]        @default([15, 60, 1440])
  quietHoursEnabled     Boolean      @default(false)
  quietHoursStart       String?
  quietHoursEnd         String?
  enabled               Boolean      @default(true)
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  integration           Integration? @relation(fields: [integrationId], references: [id])
  user                  User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([enabled])
}

model NavigationPreference {
  id                 String   @id @default(cuid())
  userId             String   @unique
  hiddenSections     String[] @default([])
  hiddenItems        String[] @default([])
  showInspiringQuote Boolean  @default(true)
  showSuggestedFocus Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CalendarPreference {
  id                  String    @id @default(cuid())
  userId              String
  provider            String    @default("google")
  selectedCalendarIds String[]  @default([])
  cachedCalendars     Json?
  cacheUpdatedAt      DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
}

model ScheduledNotification {
  id             String       @id @default(cuid())
  userId         String
  type           String
  status         String       @default("pending")
  scheduledFor   DateTime
  sentAt         DateTime?
  title          String
  message        String
  metadata       Json?
  integrationId  String?
  recipientPhone String?
  attempts       Int          @default(0)
  lastError      String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  integration    Integration? @relation(fields: [integrationId], references: [id])
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scheduledFor])
  @@index([status])
  @@index([type])
  @@index([userId, scheduledFor])
}

model WhatsAppTemplateUsage {
  id             String           @id @default(cuid())
  templateId     String
  usedAt         DateTime         @default(now())
  usedBy         String?
  recipientPhone String
  messageId      String?
  delivered      Boolean          @default(false)
  read           Boolean          @default(false)
  deliveredAt    DateTime?
  readAt         DateTime?
  variables      Json?
  status         String           @default("sent")
  errorMessage   String?
  createdAt      DateTime         @default(now())
  template       WhatsAppTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([usedAt])
  @@index([status])
}

model WhatsAppMessageAnalytics {
  id                    String         @id @default(cuid())
  whatsappConfigId      String
  date                  DateTime       @db.Date
  hour                  Int
  messagesReceived      Int            @default(0)
  messagesSent          Int            @default(0)
  messagesDelivered     Int            @default(0)
  messagesRead          Int            @default(0)
  messagesFailed        Int            @default(0)
  uniqueUsers           Int            @default(0)
  avgResponseTime       Float?
  maxResponseTime       Float?
  minResponseTime       Float?
  avgMessagesPerUser    Float?
  avgConversationLength Float?
  totalConversations    Int            @default(0)
  errorCount            Int            @default(0)
  errorRate             Float?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  whatsappConfig        WhatsAppConfig @relation(fields: [whatsappConfigId], references: [id], onDelete: Cascade)

  @@unique([whatsappConfigId, date, hour])
  @@index([whatsappConfigId, date])
  @@index([date])
}

model WhatsAppPerformanceMetrics {
  id                  String         @id @default(cuid())
  whatsappConfigId    String
  timestamp           DateTime       @default(now())
  apiCallsCount       Int            @default(0)
  apiSuccessCount     Int            @default(0)
  apiErrorCount       Int            @default(0)
  avgApiLatency       Float?
  maxApiLatency       Float?
  webhooksReceived    Int            @default(0)
  webhooksProcessed   Int            @default(0)
  webhooksFailed      Int            @default(0)
  avgWebhookLatency   Float?
  queueSize           Int            @default(0)
  queueBacklog        Int            @default(0)
  cacheHitRate        Float?
  circuitBreakerTrips Int            @default(0)
  memoryUsage         Float?
  cpuUsage            Float?
  whatsappConfig      WhatsAppConfig @relation(fields: [whatsappConfigId], references: [id], onDelete: Cascade)

  @@index([whatsappConfigId, timestamp])
  @@index([timestamp])
}

model WhatsAppRateLimitTracking {
  id                String         @id @default(cuid())
  whatsappConfigId  String
  endpoint          String
  limitType         String
  limitValue        Int
  currentUsage      Int            @default(0)
  remainingQuota    Int
  resetsAt          DateTime
  windowStart       DateTime
  warningThreshold  Float          @default(0.8)
  criticalThreshold Float          @default(0.95)
  lastAlertAt       DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  whatsappConfig    WhatsAppConfig @relation(fields: [whatsappConfigId], references: [id], onDelete: Cascade)

  @@unique([whatsappConfigId, endpoint, limitType])
  @@index([whatsappConfigId])
  @@index([resetsAt])
}

model WhatsAppWebhookDelivery {
  id               String         @id @default(cuid())
  whatsappConfigId String
  webhookId        String         @unique
  eventType        String
  payload          Json
  receivedAt       DateTime       @default(now())
  processedAt      DateTime?
  status           String         @default("pending")
  attempts         Int            @default(0)
  lastAttemptAt    DateTime?
  processingTime   Float?
  queueTime        Float?
  errorMessage     String?
  errorStack       String?
  whatsappConfig   WhatsAppConfig @relation(fields: [whatsappConfigId], references: [id], onDelete: Cascade)

  @@index([whatsappConfigId, status])
  @@index([receivedAt])
  @@index([webhookId])
}

// WhatsApp Gateway Sessions (for self-hosted WhatsApp Web bridge)
model WhatsAppGatewaySession {
  id           String    @id @default(cuid())
  sessionId    String    @unique // Session ID from the gateway
  phoneNumber  String? // Phone number once connected
  userId       String
  status       String    @default("PENDING") // PENDING, CONNECTED, DISCONNECTED, ERROR
  connectedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastPingAt   DateTime?
  errorMessage String?
  metadata     Json? // Store additional gateway info

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([sessionId])
}

// ============================================
// Action Tagging Models
// ============================================

model Tag {
  id          String    @id @default(cuid())
  name        String
  slug        String
  color       String    // Semantic color key (e.g., "avatar-red", "brand-primary")
  description String?
  isSystem    Boolean   @default(false) // System tags cannot be deleted
  workspaceId String?   // null = global tag, available in all workspaces
  createdById String?   // null for system tags
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy User?      @relation("TagCreator", fields: [createdById], references: [id], onDelete: SetNull)
  actions   ActionTag[]

  // Global tags: unique by slug (when workspaceId is null)
  // Workspace tags: unique by slug within workspace
  @@unique([slug, workspaceId])
  @@index([workspaceId])
  @@index([isSystem])
  @@index([slug])
}

model ActionTag {
  id        String   @id @default(cuid())
  actionId  String
  tagId     String
  createdAt DateTime @default(now())

  action Action @relation(fields: [actionId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([actionId, tagId])
  @@index([actionId])
  @@index([tagId])
}

enum ActionStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  CANCELLED
}

enum ViewType {
  KANBAN
  LIST
}

enum ViewGroupBy {
  STATUS
  PROJECT
  ASSIGNEE
  PRIORITY
}

// Team Weekly Planning Models
model WeeklyOutcome {
  id            String    @id @default(cuid())
  title         String
  description   String?
  weekStartDate DateTime // Start of the week (Monday)
  status        String    @default("NOT_STARTED") // NOT_STARTED, IN_PROGRESS, COMPLETED, BLOCKED
  priority      String    @default("MEDIUM") // HIGH, MEDIUM, LOW
  teamId        String
  projectId     String
  createdById   String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  dueDate       DateTime? // Optional specific due date within the week

  // Relations
  team           Team                    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  project        Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy      User                    @relation("WeeklyOutcomeCreated", fields: [createdById], references: [id])
  assignees      WeeklyOutcomeAssignee[]
  relatedActions Action[]                @relation("WeeklyOutcomeActions")

  @@unique([teamId, projectId, weekStartDate, title])
  @@index([teamId])
  @@index([projectId])
  @@index([weekStartDate])
  @@index([status])
}

model WeeklyOutcomeAssignee {
  id              String   @id @default(cuid())
  weeklyOutcomeId String
  userId          String
  assignedAt      DateTime @default(now())

  weeklyOutcome WeeklyOutcome @relation(fields: [weeklyOutcomeId], references: [id], onDelete: Cascade)
  user          User          @relation("WeeklyOutcomeAssignee", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([weeklyOutcomeId, userId])
  @@index([weeklyOutcomeId])
  @@index([userId])
}

model TeamMemberWeeklyCapacity {
  id             String   @id @default(cuid())
  userId         String
  teamId         String
  projectId      String? // Optional: project-specific capacity
  weekStartDate  DateTime
  availableHours Float    @default(40) // Default full-time capacity
  notes          String? // Vacation, part-time, etc.
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user    User     @relation("TeamMemberCapacity", fields: [userId], references: [id])
  team    Team     @relation("TeamMemberCapacities", fields: [teamId], references: [id])
  project Project? @relation("ProjectCapacities", fields: [projectId], references: [id])

  @@unique([userId, teamId, weekStartDate, projectId])
  @@index([userId])
  @@index([teamId])
  @@index([weekStartDate])
}

model WeeklyReviewSharing {
  id        String   @id @default(cuid())
  userId    String
  teamId    String
  isEnabled Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@index([userId])
  @@index([teamId])
  @@index([isEnabled])
}

model WeeklyReviewCompletion {
  id               String    @id @default(cuid())
  userId           String
  workspaceId      String?
  weekStartDate    DateTime  @db.Date // Sunday of the week
  completedAt      DateTime  @default(now())
  projectsReviewed Int       @default(0)
  statusChanges    Int       @default(0)
  priorityChanges  Int       @default(0)
  actionsAdded     Int       @default(0)
  reviewMode       String?   // "full" | "quick"
  durationMinutes  Int?      // Actual time taken to complete review

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId, weekStartDate])
  @@index([userId])
  @@index([workspaceId])
  @@index([weekStartDate])
}

// ============================================
// Wheel of Life Assessment Models
// ============================================

model WheelOfLifeAssessment {
  id          String   @id @default(cuid())
  userId      String
  completedAt DateTime @default(now())
  mode        String   @default("quick") // "quick" | "deep"
  type        String   @default("on_demand") // "on_demand" | "quarterly"
  quarterYear String? // e.g., "2026-Q1"
  notes       String?

  user            User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  scores          WheelOfLifeScore[]
  recommendations WheelOfLifeRecommendation[]

  @@index([userId])
  @@index([completedAt])
  @@index([quarterYear])
}

model WheelOfLifeScore {
  id           String @id @default(cuid())
  assessmentId String
  lifeDomainId Int

  // Priority rankings (both modes)
  currentRank Int // 1-10, where 1 = highest priority currently
  desiredRank Int // 1-10, where 1 = highest priority desired

  // Satisfaction score (Deep mode only)
  score Int? // 1-10 scale, null in Quick mode

  reflection String? // Optional reflection

  assessment WheelOfLifeAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  lifeDomain LifeDomain            @relation(fields: [lifeDomainId], references: [id])

  @@unique([assessmentId, lifeDomainId])
  @@index([assessmentId])
  @@index([lifeDomainId])
}

model WheelOfLifeRecommendation {
  id             String  @id @default(cuid())
  assessmentId   String
  lifeDomainId   Int
  recommendation String
  suggestedGoal  String?
  priority       String  @default("medium") // "high" | "medium" | "low"
  goalCreated    Boolean @default(false)
  goalId         Int?

  assessment WheelOfLifeAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
  @@index([lifeDomainId])
}

// ============================================
// Knowledge Base Models (RAG)
// ============================================

model Resource {
  id String @id @default(cuid())

  // Core content
  title       String
  description String?
  url         String? // Source URL for web pages/bookmarks
  rawContent  String? // Original HTML/content
  content     String? // Cleaned/processed text
  contentType String  @default("web_page") // "web_page" | "document" | "pdf" | "bookmark" | "note"
  mimeType    String? // e.g., "text/html", "application/pdf"

  // Metadata
  author      String?
  publishedAt DateTime?
  fetchedAt   DateTime?
  wordCount   Int?
  summary     String? // AI-generated summary

  // Organization
  tags        String[]
  userId      String
  projectId   String?
  workspaceId String?

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  archivedAt DateTime?

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project?   @relation(fields: [projectId], references: [id])
  workspace Workspace? @relation(fields: [workspaceId], references: [id])

  @@index([userId])
  @@index([projectId])
  @@index([workspaceId])
  @@index([contentType])
  @@index([url])
}

model KnowledgeChunk {
  id String @id @default(cuid())

  // Content
  content   String // Text chunk (~500 tokens)
  embedding Unsupported("vector(1536)")? // pgvector embedding

  // Source reference (polymorphic - query manually, no Prisma relations)
  sourceType String // "transcription" | "resource"
  sourceId   String // ID of TranscriptionSession or Resource

  // Position info
  chunkIndex Int // Order within source
  tokenCount Int?
  startPos   Int? // Character position in source
  endPos     Int?

  // Filtering
  userId    String
  projectId String?

  createdAt DateTime @default(now())

  @@index([sourceType, sourceId])
  @@index([userId])
  @@index([projectId])
}

// ============================================
// CRM Models
// ============================================

model CrmContact {
  id                  String    @id @default(cuid())
  workspaceId         String
  firstName           String?
  lastName            String?
  email               Bytes?   @map("email_encrypted") @db.ByteA
  phone               Bytes?   @map("phone_encrypted") @db.ByteA
  linkedIn            Bytes?   @map("linkedIn_encrypted") @db.ByteA
  telegram            Bytes?   @map("telegram_encrypted") @db.ByteA
  twitter             Bytes?   @map("twitter_encrypted") @db.ByteA
  github              Bytes?   @map("github_encrypted") @db.ByteA
  about               String?   @db.Text
  skills              String[]
  tags                String[]
  lastInteractionAt   DateTime?
  lastInteractionType String?
  organizationId      String?
  createdById         String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Gmail/Calendar import fields
  connectionScore     Int?      @default(0)  // 0-100 calculated score
  emailHash          String?   @unique      // SHA-256 for deduplication
  importSource       String?                // "GMAIL", "CALENDAR", "MANUAL"
  googleContactId    String?                // Google People API ID
  lastSyncedAt       DateTime?              // Last import sync time

  workspace      Workspace               @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  organization   CrmOrganization?        @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  createdBy      User?                   @relation("CrmContactCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  interactions   CrmContactInteraction[]
  communications CrmCommunication[]

  @@index([workspaceId])
  @@index([organizationId])
  @@index([createdById])
  @@index([email])
  @@index([lastInteractionAt])
  @@index([emailHash])
  @@index([connectionScore])
  @@index([workspaceId, importSource])
}

model CrmOrganization {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  websiteUrl  String?
  logoUrl     String?
  description String?  @db.Text
  industry    String?
  size        String? // "1-10" | "11-50" | "51-200" | "201-500" | "501-1000" | "1000+"
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy User?        @relation("CrmOrganizationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  contacts  CrmContact[]

  @@index([workspaceId])
  @@index([createdById])
  @@index([name])
}

model CrmContactInteraction {
  id         String   @id @default(cuid())
  contactId  String
  workspaceId String
  userId     String?
  type       String // EMAIL, TELEGRAM, PHONE_CALL, MEETING, NOTE, LINKEDIN, OTHER
  direction  String // INBOUND, OUTBOUND, BIDIRECTIONAL
  subject    String?
  notes      String?  @db.Text
  metadata   Json? // Additional data like email thread ID, call duration, etc.
  occurredAt DateTime @default(now()) // When interaction happened
  createdAt  DateTime @default(now())

  contact   CrmContact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  workspace Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User?      @relation("CrmInteractionUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([contactId])
  @@index([workspaceId])
  @@index([userId])
  @@index([type])
  @@index([occurredAt])
  @@index([createdAt])
}

model CrmCommunication {
  id           String    @id @default(cuid())
  contactId    String?
  workspaceId  String
  type         String // EMAIL, TELEGRAM, SMS
  fromEmail    Bytes?   @map("from_email_encrypted") @db.ByteA
  toEmail      Bytes?   @map("to_email_encrypted") @db.ByteA
  fromTelegram Bytes?   @map("from_telegram_encrypted") @db.ByteA
  toTelegram   Bytes?   @map("to_telegram_encrypted") @db.ByteA
  subject      String?
  textContent  String?   @db.Text
  htmlContent  String?   @db.Text
  status       String    @default("DRAFT") // DRAFT, QUEUED, SENT, FAILED, CANCELLED
  sentAt       DateTime?
  openedAt     DateTime?
  clickedAt    DateTime?
  bouncedAt    DateTime?
  errorMessage String?  @map("error_message_redacted")
  errorCode    String?  @map("error_code")
  externalId   String? // ID from external service (e.g., Postmark message ID)
  metadata     Json? // Additional tracking data
  createdById  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  contact   CrmContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  workspace Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy User?       @relation("CrmCommunicationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([contactId])
  @@index([workspaceId])
  @@index([createdById])
  @@index([status])
  @@index([type])
  @@index([sentAt])
}

model CrmCommunicationTemplate {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  subject     String?
  textContent String?  @db.Text
  htmlContent String?  @db.Text
  type        String // EMAIL, TELEGRAM, SMS
  variables   String[] // Template variable names like ["firstName", "companyName"]
  isActive    Boolean  @default(true)
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy User?     @relation("CrmTemplateCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([type])
  @@index([isActive])
}

model ContactImportBatch {
  id                 String    @id @default(cuid())
  workspaceId        String
  status             String    // PENDING, IN_PROGRESS, COMPLETED, FAILED, PARTIAL_SUCCESS
  source             String    // GMAIL, CALENDAR, BOTH
  totalContacts      Int       @default(0)
  processedContacts  Int       @default(0)
  newContacts        Int       @default(0)
  updatedContacts    Int       @default(0)
  errorCount         Int       @default(0)
  googleSyncToken    String?   // For incremental syncs
  metadata           Json?     // Error messages, warnings
  createdById        String
  createdAt          DateTime  @default(now())
  completedAt        DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy User      @relation("CrmImportBatchCreatedBy", fields: [createdById], references: [id])

  @@index([workspaceId])
  @@index([createdById])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// Plugin System Models
// ============================================

model PluginConfig {
  id          String    @id @default(cuid())
  pluginId    String
  workspaceId String?
  userId      String
  enabled     Boolean   @default(true)
  settings    Json      @default("{}")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pluginId, workspaceId, userId])
  @@index([pluginId])
  @@index([workspaceId])
  @@index([userId])
}

// ============================================
// OKR (Objectives & Key Results) Models
// ============================================

model KeyResult {
  id           String    @id @default(cuid())
  title        String
  description  String?
  targetValue  Float
  currentValue Float     @default(0)
  startValue   Float     @default(0)
  unit         String    @default("percent") // "percent", "count", "currency", "hours", "custom"
  unitLabel    String? // Custom label like "$" or "users"
  period       String // "Q1-2025", "H1-2025", "Annual-2025"
  periodStart  DateTime?
  periodEnd    DateTime?
  status       String    @default("on-track") // "on-track", "at-risk", "off-track", "achieved"
  confidence   Int? // 0-100 confidence score
  goalId       Int
  userId       String
  driUserId    String?
  workspaceId  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  goal      Goal                @relation(fields: [goalId], references: [id], onDelete: Cascade)
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  driUser   User?               @relation("KeyResultDRI", fields: [driUserId], references: [id])
  workspace Workspace?          @relation(fields: [workspaceId], references: [id])
  checkIns  KeyResultCheckIn[]
  comments  KeyResultComment[] // Discussion comments on this key result
  projects  KeyResultProject[] // Projects linked to this key result

  @@index([goalId])
  @@index([userId])
  @@index([driUserId])
  @@index([workspaceId])
  @@index([period])
  @@index([status])
}

model KeyResultCheckIn {
  id            String   @id @default(cuid())
  keyResultId   String
  previousValue Float
  newValue      Float
  notes         String?
  createdAt     DateTime @default(now())
  createdById   String

  keyResult KeyResult @relation(fields: [keyResultId], references: [id], onDelete: Cascade)
  createdBy User      @relation("KeyResultCheckInCreator", fields: [createdById], references: [id])

  @@index([keyResultId])
  @@index([createdAt])
}

model KeyResultProject {
  id          String   @id @default(cuid())
  keyResultId String
  projectId   String
  assignedAt  DateTime @default(now())

  keyResult KeyResult @relation(fields: [keyResultId], references: [id], onDelete: Cascade)
  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([keyResultId, projectId])
  @@index([keyResultId])
  @@index([projectId])
}

// ============================================
// OKR Check-in Models (Team Weekly Sync)
// ============================================

model OkrCheckin {
  id              String    @id @default(cuid())
  teamId          String
  workspaceId     String
  weekStartDate   DateTime  @db.Date
  status          String    @default("PREPARING") // PREPARING | IN_PROGRESS | COMPLETED
  facilitatorId   String
  startedAt       DateTime?
  completedAt     DateTime?
  durationMinutes Int?
  notes           String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  team          Team                   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  workspace     Workspace              @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  facilitator   User                   @relation("OkrCheckinFacilitator", fields: [facilitatorId], references: [id])
  statusUpdates OkrCheckinUpdate[]
  agendaItems   OkrCheckinAgendaItem[]

  @@unique([teamId, weekStartDate])
  @@index([teamId])
  @@index([workspaceId])
  @@index([weekStartDate])
  @@index([status])
}

model OkrCheckinUpdate {
  id              String    @id @default(cuid())
  okrCheckinId    String
  userId          String
  accomplishments String?   @db.Text
  blockers        String?   @db.Text
  priorities      String?   @db.Text
  isSubmitted     Boolean   @default(false)
  submittedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  okrCheckin OkrCheckin          @relation(fields: [okrCheckinId], references: [id], onDelete: Cascade)
  user       User                @relation("OkrCheckinUpdateUser", fields: [userId], references: [id])
  comments   OkrCheckinComment[]

  @@unique([okrCheckinId, userId])
  @@index([okrCheckinId])
  @@index([userId])
  @@index([isSubmitted])
}

model OkrCheckinComment {
  id        String   @id @default(cuid())
  updateId  String
  authorId  String
  content   String   @db.Text
  createdAt DateTime @default(now())

  update OkrCheckinUpdate @relation(fields: [updateId], references: [id], onDelete: Cascade)
  author User             @relation("OkrCheckinCommentAuthor", fields: [authorId], references: [id])

  @@index([updateId])
  @@index([authorId])
}

// OKR Discussion Comments - for Objectives (Goals)
model GoalComment {
  id        String   @id @default(cuid())
  goalId    Int
  authorId  String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  goal   Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  author User @relation("GoalCommentAuthor", fields: [authorId], references: [id])

  @@index([goalId])
  @@index([authorId])
  @@index([createdAt])
}

// OKR Discussion Comments - for Key Results
model KeyResultComment {
  id          String   @id @default(cuid())
  keyResultId String
  authorId    String
  content     String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  keyResult KeyResult @relation(fields: [keyResultId], references: [id], onDelete: Cascade)
  author    User      @relation("KeyResultCommentAuthor", fields: [authorId], references: [id])

  @@index([keyResultId])
  @@index([authorId])
  @@index([createdAt])
}

model OkrCheckinAgendaItem {
  id              String    @id @default(cuid())
  okrCheckinId    String
  order           Int
  type            String    // STANDUP | BLOCKERS | OKR_REVIEW | PROJECT_HEALTH | DISCUSSION
  title           String
  durationMinutes Int       @default(5)
  isCompleted     Boolean   @default(false)
  completedAt     DateTime?
  notes           String?   @db.Text
  createdAt       DateTime  @default(now())

  okrCheckin OkrCheckin @relation(fields: [okrCheckinId], references: [id], onDelete: Cascade)

  @@index([okrCheckinId])
}

// ============================================
// Daily Planning Wizard Models
// ============================================

model DailyPlan {
  id           String   @id @default(cuid())
  userId       String
  workspaceId  String?
  date         DateTime
  shutdownTime String?  // "17:00" format
  obstacles    String?  @db.Text
  status       String   @default("DRAFT") // DRAFT, COMPLETED
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace      Workspace?        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  plannedActions DailyPlanAction[]

  @@unique([userId, date, workspaceId])
  @@index([userId])
  @@index([workspaceId])
  @@index([date])
}

model DailyPlanAction {
  id               String    @id @default(cuid())
  dailyPlanId      String
  actionId         String?   // Link to existing Action (null for inline-created)
  name             String
  duration         Int       @default(30) // Duration in minutes
  scheduledStart   DateTime?
  scheduledEnd     DateTime?
  sortOrder        Int       @default(0)
  source           String    @default("manual") // manual, notion, monday, calendar
  sourceId         String?   // External ID from integration
  completed        Boolean   @default(false)
  schedulingMethod String?   // "manual" | "auto-suggested" - tracks how task was scheduled
  createdAt        DateTime  @default(now())

  dailyPlan DailyPlan @relation(fields: [dailyPlanId], references: [id], onDelete: Cascade)
  action    Action?   @relation(fields: [actionId], references: [id], onDelete: SetNull)

  @@index([dailyPlanId])
  @@index([actionId])
}

// ============================================
// Webhook Activity Logging
// ============================================

model WebhookLog {
  id           String   @id @default(cuid())
  provider     String   // "fireflies"
  eventType    String   // "webhook_received", "signature_verified", "signature_failed", "transcript_fetched", "manual_sync", "transcription_saved"
  status       String   // "success", "failed", "invalid_signature"
  meetingId    String?
  meetingTitle String?
  errorMessage String?  @db.Text
  metadata     Json?
  userId       String?
  workspaceId  String?
  createdAt    DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([workspaceId])
  @@index([provider])
  @@index([createdAt])
  @@index([status])
}

// ============================================
// Motion-like Auto-Scheduling Models
// ============================================

model TaskSchedule {
  id             String          @id @default(cuid())
  name           String
  isDefault      Boolean         @default(false)
  startTime      String          // "09:00"
  endTime        String          // "17:00"
  daysOfWeek     Int[]           // [1,2,3,4,5] = Mon-Fri (0=Sun, 6=Sat)
  workspaceId    String
  createdById    String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  workspace      Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy      User            @relation("TaskScheduleCreator", fields: [createdById], references: [id])
  actions        Action[]
  recurringTasks RecurringTask[]

  @@index([workspaceId])
  @@index([createdById])
  @@index([isDefault])
}

model RecurringTask {
  id             String        @id @default(cuid())
  name           String
  description    String?
  priority       String        @default("Medium")
  duration       Int           @default(30)

  // Recurrence pattern
  repeatPattern  String        // "daily" | "weekly" | "monthly" | "custom"
  repeatDays     Int[]         // [1,3,5] = Mon, Wed, Fri (0=Sun, 6=Sat)
  repeatInterval Int           @default(1)

  // Schedule preferences
  scheduleId     String?
  idealStartTime String?

  // Active period
  startDate      DateTime
  endDate        DateTime?

  projectId      String?
  workspaceId    String
  createdById    String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  instances      Action[]      @relation("RecurringInstances")
  project        Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  workspace      Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy      User          @relation("RecurringTaskCreator", fields: [createdById], references: [id])
  schedule       TaskSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([projectId])
  @@index([createdById])
  @@index([scheduleId])
}
